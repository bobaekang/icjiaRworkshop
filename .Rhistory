FQA_CONV_FA_VIOL_FLAG = as.factor(ifelse(any(GUILTY_FA_VIOL), 1, 0))
)
# TRANSFORM DATA 4: REARRESTS
#-------------------------------------------------------------------------------
# get variables on recidivating arrets
recid_vars <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1),
RECID_FA_NUM = sum(FA),
RECID_FA_VIOL_NUM = sum(FA_VIOL)
)
# get variables on fra convictions
recid_conv_vars <- sample_cd %>%
filter(DCN %in% sample_recid$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%
group_by(STATEID) %>%
summarise(
RECID_CONV_NUM = sum(GUILTY),
RECID_CONV_FELONY_NUM = sum(GUILTY_FEL),
RECID_CONV_FA_NUM = sum(GUILTY_FA),
RECID_CONV_FA_VIOL_NUM = sum(GUILTY_FA_VIOL)
)
sample_fqa %>%
select(STATEID, EXPERIMENT:MATCHED) %>%
left_join(fqa_vars) %>%
left_join(fqa_conv_vars) %>%
left_join(fra_vars) %>%
left_join(fra_conv_vars) %>%
left_join(recid_vars) %>%
left_join(recid_conv_vars) %>%
unique()
# get variables on fra convictions
fra_conv_vars <- sample_cd %>%
filter(DCN %in% sample_fra$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%oup_by(STATEID) %>%
summarise(
FRA_CONV_FLAG = as.factor(ifelse(any(GUILTY), 1, 0)),
FRA_CONV_FELONY_FLAG = as.factor(ifelse(any(GUILTY_FEL), 1, 0)),
FRA_CONV_FA_FLAG = as.factor(ifelse(any(GUILTY_FA), 1, 0)),
FRA_CONV_FA_VIOL_FLAG = as.factor(ifelse(any(GUILTY_FA_VIOL), 1, 0))
)
# get variables on fra convictions
fra_conv_vars <- sample_cd %>%
filter(DCN %in% sample_fra$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%
group_by(STATEID) %>%
summarise(
FRA_CONV_FLAG = as.factor(ifelse(any(GUILTY), 1, 0)),
FRA_CONV_FELONY_FLAG = as.factor(ifelse(any(GUILTY_FEL), 1, 0)),
FRA_CONV_FA_FLAG = as.factor(ifelse(any(GUILTY_FA), 1, 0)),
FRA_CONV_FA_VIOL_FLAG = as.factor(ifelse(any(GUILTY_FA_VIOL), 1, 0))
)
sample_fqa %>%
select(STATEID, EXPERIMENT:MATCHED) %>%
left_join(fqa_vars) %>%
left_join(fqa_conv_vars) %>%
left_join(fra_vars) %>%
left_join(fra_conv_vars) %>%
left_join(recid_vars) %>%
left_join(recid_conv_vars) %>%
unique()
# TRANSFORM DATA 5: MERGE TABLES
#-------------------------------------------------------------------------------
sample_fqa %>%
select(STATEID, EXPERIMENT:MATCHED) %>%
left_join(fqa_vars) %>%
left_join(fqa_conv_vars) %>%
left_join(fra_vars) %>%
left_join(fra_conv_vars) %>%
left_join(recid_vars) %>%
left_join(recid_conv_vars) %>%
unique() %>%
View()
colnames(sample_aca)
sample_aca %>%
filter(ARRDATE < FQA_ARRDATE) %>%
group_by(STATEID) %>%
count()
sample_aca %>%
filter(ARRDATE < FQA_ARRDATE)
sample_aca
recid_vars <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1),
RECID_FA_NUM = sum(FA),
RECID_FA_VIOL_NUM = sum(FA_VIOL)
)
# get variables on fra convictions
recid_conv_vars <- sample_cd %>%
filter(DCN %in% sample_recid$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%
group_by(STATEID) %>%
summarise(
RECID_CONV_NUM = sum(GUILTY),
RECID_CONV_FELONY_NUM = sum(GUILTY_FEL),
RECID_CONV_FA_NUM = sum(GUILTY_FA),
RECID_CONV_FA_VIOL_NUM = sum(GUILTY_FA_VIOL)
)
head(recid_vars)
recid_vars <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1, na.rm = TRUE),
RECID_FA_NUM = sum(FA, na.rm = TRUE),
RECID_FA_VIOL_NUM = sum(FA_VIOL, na.rm = TRUE)
)
head(recid_vars)
View(recid_vars)
# get variables on fra convictions
recid_conv_vars <- sample_cd %>%
filter(DCN %in% sample_recid$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%
group_by(STATEID) %>%
summarise(
RECID_CONV_NUM = sum(GUILTY, na.rm = TRUE),
RECID_CONV_FELONY_NUM = sum(GUILTY_FEL, na.rm = TRUE),
RECID_CONV_FA_NUM = sum(GUILTY_FA, na.rm = TRUE),
RECID_CONV_FA_VIOL_NUM = sum(GUILTY_FA_VIOL, na.rm = TRUE)
)
is.na(fra_conv_vars)
any(is.na(fra_conv_vars))
any(is.na(fra_vars))
any(is.na(fqa_conv_vars))
any(is.na(fqa_vars))
any(is.na(recid_vars))
any(is.na(recid_conv_vars))
recid_vars <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID, DCN) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1, na.rm = TRUE),
RECID_FA_NUM = sum(FA, na.rm = TRUE),
RECID_FA_VIOL_NUM = sum(FA_VIOL, na.rm = TRUE)
)
recid_vars
recid_vars <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID, DCN) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1, na.rm = TRUE),
RECID_FA_NUM = sum(FA, na.rm = TRUE),
RECID_FA_VIOL_NUM = sum(FA_VIOL, na.rm = TRUE)
) %>%
group_by(STATEID) %>%
summarise(
RECID_NUM = sum(RECID_NUM),
RECID_FELONY_NUM = sum(RECID_FELONY_NUM),
RECID_FA_NUM = sum(RECID_FA_NUM),
RECID_FA_VIOL_NUM = sum(RECID_FA_VIOL_NUM)
)
View(recid_vars)
recid_vars2 <- sample_recid %>%
left_join(
ucrcode_to_chricat %>%
mutate(UCRCODE = as.character(ucrcode))
) %>%
left_join(
firearm_offenses %>%
select(
STATUTETEXT = FIREARM_STATUTETEXT,
FIREARM,
FIREARM_VIOL
)
) %>%
mutate(
OFFNCLASS = hash_offense[[SCOOCOOC]],
FA = FIREARM == 1,
FA_VIOL = FIREARM_VIOL == 1
) %>%
group_by(STATEID) %>%
summarise(
RECID_NUM = n(),
RECID_FELONY_NUM = sum(OFFNCLASS == 1, na.rm = TRUE),
RECID_FA_NUM = sum(FA, na.rm = TRUE),
RECID_FA_VIOL_NUM = sum(FA_VIOL, na.rm = TRUE)
)
all(recid_vars == recid_vars2)
all.equal(recid_vars, recid_vars2)
identical(recid_vars, recid_vars2)
# get variables on fra convictions
recid_conv_vars <- sample_cd %>%
filter(DCN %in% sample_recid$DCN) %>%
mutate(
GUILTY = CDCCODE %in% 101:107,
FELONY = SCOOCOOC %in% c("M", "X", "1", "2", "3", "4", "F"),
FIREARM = STATUTE %in% firearm_offenses$FIREARM_STATUTETEXT,
FIREARM_VIOL = STATUTE %in% filter(firearm_offenses, FIREARM_VIOL == 1)$FIREARM_STATUTETEXT
) %>%
mutate(
GUILTY_FEL = GUILTY & FELONY,
GUILTY_FA = GUILTY & FIREARM,
GUILTY_FA_VIOL = GUILTY & FIREARM_VIOL
) %>%
group_by(STATEID, DCN) %>%
summarise(
RECID_CONV_NUM = sum(GUILTY, na.rm = TRUE),
RECID_CONV_FELONY_NUM = sum(GUILTY_FEL, na.rm = TRUE),
RECID_CONV_FA_NUM = sum(GUILTY_FA, na.rm = TRUE),
RECID_CONV_FA_VIOL_NUM = sum(GUILTY_FA_VIOL, na.rm = TRUE)
) %>%
group_by(STATEID) %>%
summarise(
RECID_CONV_NUM = sum(RECID_CONV_NUM),
RECID_CONV_FELONY_NUM = sum(RECID_CONV_FELONY_NUM),
RECID_CONV_FA_NUM = sum(RECID_CONV_FA_NUM),
RECID_CONV_FA_VIOL_NUM = sum(RECID_CONV_FA_VIOL_NUM)
)
# old CHRI tables
arrests <- read_feather("data/RE_arrests.feather")
court_disps <- read_feather("data/RE_court_disps.feather")
sample_fqa
sample_aca %>%
select(STATEID, FQA_ARRDATE) %>%
unique()
sample_aca %>%
select(STATEID, FQA_ARRDATE) %>%
unique() %>%
left_join(arrests) %>%
filter(ARRDATE < FQA_ARRDATE) %>%
group_by(STATEID) %>%
count()
sample_prior <- sample_aca %>%
select(STATEID, FQA_ARRDATE) %>%
unique() %>%
left_join(arrests) %>%
mutate(ARRDATE = as.Date(ARRDATE), "%m/%d/%Y") %>%
filter(ARRDATE < FQA_ARRDATE)
class(arrests$ARRDATE)
head(arrests$ARRDATE)
sample_arrests_prior <- sample_aca %>%
select(STATEID, FQA_ARRDATE) %>%
unique() %>%
left_join(arrests) %>%
mutate(ARRDATE = as.Date(ARRDATE, "%m/%d/%Y")) %>%
filter(ARRDATE < FQA_ARRDATE)
prior_arr_num <- sample_arrests_prior %>%
group_by(STATEID) %>%
count()
prior_arr_num
prior_arr_num <- sample_arrests_prior %>%
group_by(STATEID) %>%
summarise(PRIOR_ARR_NUM = n())
prior_num <- sample_arrests_prior %>%
group_by(STATEID) %>%
summarise(PRIOR_NUM = n())
prior_conv_num <- court_disps %>%
filter(DCN %in% sample_arrests_prior$DCN) %>%
group_by(STATEID) %>%
summarise(PRIOR_CONV_NUM = n())
prior_conv_num <- court_disps %>%
filter(DCN %in% sample_arrests_prior$DCN) %>%
group_by(STATEID = MIND_SID) %>%
summarise(PRIOR_CONV_NUM = n())
prior_conv_num
prior_conv_num <- court_disps %>%
filter(DCN %in% sample_arrests_prior$DCN) %>%
group_by(STATEID = MIND_SID, DCN) %>%
count() %>%
group_by(STATEID) %>%
summarise(PRIOR_CONV_NUM = n())
prior_conv_num
prior_num <- sample_arrests_prior %>%
group_by(STATEID = MIND_SID, DCN) %>%
count() %>%
group_by(STATEID) %>%
summarise(PRIOR_NUM = n())
prior_num <- sample_arrests_prior %>%
group_by(STATEID, DCN) %>%
count() %>%
group_by(STATEID) %>%
summarise(PRIOR_NUM = n())
prior_num
# TRANSFORM DATA 5: MERGE TABLES
#-------------------------------------------------------------------------------
sample_fqa %>%
select(STATEID, EXPERIMENT:MATCHED) %>%
left_join(prior_num) %>%
left_join(prior_conv_num) %>%
left_join(fqa_vars) %>%
left_join(fqa_conv_vars) %>%
left_join(fra_vars) %>%
left_join(fra_conv_vars) %>%
left_join(recid_vars) %>%
left_join(recid_conv_vars) %>%
unique() %>%
View()
chri_vars <- sample_fqa %>%
select(STATEID, EXPERIMENT:MATCHED) %>%
left_join(prior_num) %>%
left_join(prior_conv_num) %>%
left_join(fqa_vars) %>%
left_join(fqa_conv_vars) %>%
left_join(fra_vars) %>%
left_join(fra_conv_vars) %>%
left_join(recid_vars) %>%
left_join(recid_conv_vars) %>%
unique()
source("helpers/replace_na.R")
dim(recid_vars)
length(unique(recid_vars$STATEID))
colnames(chri_vars)
spss_table <- read_sav("data_manually_collected/FinalAnalysisTable_DC Codes 011218.sav")
spss_table <- haven::read_sav("data_manually_collected/FinalAnalysisTable_DC Codes 011218.sav")
dim(spss_table)
colnames(spss_table)
spss_table <- haven::read_sav("data_manually_collected/FinalAnalysisTable_111517.sav")
dim(spss_table)
spss_table %>% filteR()
colnames(spss_table)
spss_table %>% group_by(Matched_UseInStudy) %>% count9
spss_table %>% group_by(Matched_UseInStudy) %>% count)
spss_table %>% group_by(Matched_UseInStudy) %>% count()
10842-10866
10842-377
10465 * .04
10465 * .05
10465 * .01
10465 * .005
10465 - 39
library(odbc)
con <- DBI::dbConnect(odbc::odbc(), Driver = "SQL Server", Server = "SPAC2SVR",
Port = 1433)
read_feather("data/RE_sample_idoc_vars.feather")
8+2+3+9
?MASS::parcoord()
iris
colnames(iris)
MASS::parcoord(iris, col=Species)
MASS::parcoord(iris, col="Species")
MASS::parcoord(select(iris, -Species), col=select(iris, Species))
iris[,c(1,2,3,4)
iris[,c(1,2,3,4)]
iris
iris[,c(1, 2, 3, 4)]
MASS::parcoord(iris[,c(1, 2, 3, 4)])
MASS::parcoord(iris[,c(1, 2, 3, 4)], col=iris[,5])
colors()
ASS::parcoord(
iris[,c(1, 2, 3, 4)],
col = colors()[as.numeric(iris$Species)*11]
)
MASS::parcoord(
iris[,c(1, 2, 3, 4)],
col = colors()[as.numeric(iris$Species)*11]
)
library(MASS)
parcoord(
iris[,c(1, 2, 3, 4)],
col = colors()[as.numeric(iris$Species)*11]
)
parcoord(
iris[, c(1, 2, 3, 4, 5)],
col = colors()[as.numeric(iris$Species)*11]
)
color()
colors()
parcoord(
iris[, c(1, 2, 3, 4)]
# col = colors()[as.numeric(iris$Species)*11]
)
col = colors()[as.numeric(iris$Species)*11]
parcoord(
iris[, c(1, 2, 3, 4)],
col = colors()[as.numeric(iris$Species)*11]
)
?MASS
??MASS
setwd("X:/_icjia_github/icjia-r-workshop")
setwd("X:/_icjia_github/icjia-r-workshop/notes")
install.packages(c("BH", "callr", "digest", "DT", "haven", "hexbin", "Hmisc", "hms", "htmlTable", "htmlwidgets", "irlba", "knitr", "lubridate", "mapview", "MatchIt", "mvtnorm", "odbc", "openssl", "Rcpp", "RCurl", "reprex", "sf", "sp", "spData", "survminer", "tidyr", "tmap", "tmaptools", "TTR", "units", "viridis", "viridisLite", "xml2", "zoo"))
install.packages(c("tmap", "tmaptools"))
install.packages("digest")
